{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}
{% load bootstrap %}

<form class="modal-form" id="npOrderForm" method="post" 
      hx-post="{% url 'create_np_document_for_order' order.id %}"
      hx-swap="none">
    {% csrf_token %}
    <input type="hidden" name="order_id" value="{{ order.id }}">
    <div class="modal-body-content">
        {{ placeForm|crispy }}
        {{ inputForm.sender_np_place|as_crispy_field }}
        <div class="row g-3">
            <div class="col-sm">
                {{ inputForm.payment_user_type|as_crispy_field }}
            </div>
            <div class="col-sm">
                {{ inputForm.payment_money_type|as_crispy_field }}
            </div>
        </div>
        <div class="row bg-light rounded p-2 mx-auto my-2">
            <div class="hstack gap-2">
                <div class="col-sm">
                    {{ inputForm.weight|as_crispy_field }}
                </div>
                <div class="col-sm">
                    {{ inputForm.width|as_crispy_field }}
                </div>
                <div class="col-sm">
                    {{ inputForm.length|as_crispy_field }}
                </div>
                <div class="col-sm">
                    {{ inputForm.height|as_crispy_field }}
                </div>
                <button class="btn btn-outline-primary" hx-post="{% url 'add_more_np_places_input_group' %}" hx-target="#add_more_places_input_group" hx-swap="beforebegin"><i class="bi bi-plus-circle"></i></button>
                <button class="btn btn-outline-warning" hx-post="{% url 'copy_np_places_input_group' %}" hx-vals='{ "weight": {{ inputForm.weight }}, "width": {{ inputForm.width }}, "length": {{ inputForm.length }}, "height": {{ inputForm.height }}  }' hx-target="#add_more_places_input_group" hx-swap="beforebegin"><i class="bi bi-clipboard2-fill"></i></button>
            </div>
        </div>

        <div id="add_more_places_input_group">
        </div>

        <div class="row g-3">
            <div class="col-sm">
                {{ inputForm.description|as_crispy_field }}
            </div>
        </div>

        <div class="row g-3">
            <div class="col-sm">
                {{ inputForm.cost|as_crispy_field }}
            </div>
            <div class="col-sm">
                {{ inputForm.dateDelivery|as_crispy_field }}
            </div>
        </div>

        {% if messages %}
        <div class="alert alert-danger my-4">
            {% for message in messages %}
            <div{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</div>
            {% endfor %}
        </div>
        <div class="alert alert-warning">
            <p class="mb-2"><em>Якщо отримали помилку, про те, що: Aдреса отримувача не належить отримувачу, потрібно додати адресу до організації, для якої попередньо вже було додано ЄДРПОУ</em></p>
            <p class="mb-0"><em>Якщо отримали помилку, про те, що: "ContactSender is removed" -> Settings -> Нова пошта REF INFO -> Sync REF with myself -> Навпроти свого імені нажати кнопку</em></p>
        </div>
        <div id="error"></div>
        {% endif %}

        <input type="hidden" name="next" value="{{ request.GET.next }}">
        
        <div class="d-flex gap-2 justify-content-center mt-4" style="height: 38px; position: relative;">
          <div id="mainButtons">
            <button class="btn btn-primary" type="submit" name="save_and_print" value="1">
              <i class="bi bi-printer"></i> Зберегти та друкувати
            </button>
            <button class="btn btn-primary" type="submit" name="save_and_exit" id="submitButton" value="1">
              <i class="bi bi-x-square"></i> Зберегти та вийти
            </button>
          </div>
          <div id="loadingSpinner" style="display: none; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
            <span class="spinner-border spinner-border-sm text-primary" style="width: 1.5rem; height: 1.5rem;"></span>
          </div>
        </div>

        <div class="alert alert-info mt-4 small">
            <p class="mb-2"><strong>При створенні ЕН з відділення типу поштомату обов'язково вказуються параметри розмірів.</strong></p>
            <p class="mb-2"><strong>Обмеження:</strong></p>
            <ul class="mb-0 ps-3">
                <li>Максимальне значення оцінної вартості для відправки із поштомату (параметр Cost) – 10000 грн.</li>
                <li>Максимально допустимі габарити вантажу: Ширина 40 см; Довжина 60 см; Висота 30 см</li>
                <li>Максимально допустима вага вантажу 20 кг</li>
                <li>При створенні відправлення із поштомату можна вказувати лише одне місце на одне відправлення</li>
                <li>Після створення інтернет документа, ЕН з'являється у списку ЕН в особистому кабінеті</li>
            </ul>
            <hr>
            <p class="mb-2"><strong>Важлива інформація щодо помилок:</strong></p>
            <ul class="mb-0 ps-3">
                <li>"Aдреса отримувача не належить отримувачу": потрібно додати адресу до організації, для якої попередньо вже було додано ЄДРПОУ</li>
                <li>"ContactSender is removed": Меню -> Settings -> Нова пошта REF INFO -> Sync REF with myself -> Навпроти свого імені нажати sync</li>
            </ul>
        </div>
    </div>
</form>

<script>
    // Show loading spinner
    function showLoadingSpinner() {
        // Hide main buttons
        document.getElementById('mainButtons').style.display = 'none';
        // Show loading spinner
        document.getElementById('loadingSpinner').style.display = 'block';
    }

    // Hide loading spinner
    function hideLoadingSpinner() {
        // Show main buttons
        document.getElementById('mainButtons').style.display = 'block';
        // Hide loading spinner
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // Reset spinner state when modal is opened
    function resetSpinnerState() {
        // Show main buttons
        document.getElementById('mainButtons').style.display = 'block';
        // Hide loading spinner
        document.getElementById('loadingSpinner').style.display = 'none';
    }

    // Add HTMX event listeners
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
            // Only show spinner for our form submission
            if (evt.detail.target.id === 'npOrderForm') {
                showLoadingSpinner();
            }
        });

    // WebSocket connection
    const socket = new WebSocket('wss://' + window.location.host + '/wss/np_document_updates/');

    socket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.message) {
            hideLoadingSpinner();
            if (data.message == 'Накладна успішно створена') {
                if (data.delivery_order_id) {
                window.open(data.delivery_order_id, '_blank');
            }
            const orderIdInput = document.querySelector('input[name="order_id"]');
            const orderId = orderIdInput ? orderIdInput.value : null;
            if (orderId) {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    window.location.href = '/orders';
                } else {
                    htmx.ajax('POST', `orderCellUpdateNPStatus/${orderId}`, {
                        target: `#order_preview_cell${orderId}`,
                        swap: 'innerHTML'
                    });
                }
                const modal = document.querySelector('.modal');
                if (modal) {
                    console.log('MODAL found!');
                    // Use Bootstrap 5's data-bs-dismiss attribute
                    const closeButton = modal.querySelector('[data-bs-dismiss="modal"]');
                    if (closeButton) {
                        closeButton.click();
                    } else {
                        // Fallback: hide the modal directly
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                    }
                }
                return;
            }
            } else {
                alert(data.message);
            }
        }
    };

    socket.onclose = function(e) {
        console.error('WebSocket closed unexpectedly:', e);
    };

    socket.onerror = function(e) {
        console.error('WebSocket error:', e);
    };
</script>

<style>
.modal-form {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    padding-bottom: 1rem;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
}

/* Hide scrollbar for Chrome, Safari and Opera */
.modal-form::-webkit-scrollbar {
    display: none;
}

.modal-body-content {
    padding-left: 1rem;
    padding-right: 1rem;
    scroll-padding-bottom: 1rem;
    scroll-padding-top: 1rem;
}
.alert {
    margin-bottom: 1rem;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
    .modal-form {
        max-height: calc(100vh - 100px);
        padding-bottom: 2rem;
    }
    
    .modal-body-content {
        padding: 0.75rem;
    }
    
    /* Ensure buttons have enough space at the bottom */
    .d-flex.gap-2.justify-content-center {
        margin-bottom: 1rem;
    }
    
    /* Adjust alert spacing on mobile */
    .alert {
        margin-bottom: 0.75rem;
    }
}
</style>